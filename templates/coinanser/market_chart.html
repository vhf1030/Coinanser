{% extends 'base.html' %}
{% load coinanser_filter %}
{% block content %}
<html>
  <head>
    <script type="text/javascript">
      // google.charts.load('current', {'packages':['line']});
      // core chart 사용시 tooltip 변경이 자유로움 - corechart로 변경하는 부분 보류
      // google.charts.load('current', {'packages':['corechart']});
      google.charts.load('current', {'packages':['line', 'corechart']});
      google.charts.setOnLoadCallback(drawChart);

    function drawChart() {

      var data = new google.visualization.DataTable();
      data.addColumn('datetime');
      data.addColumn('number', '고가');
      data.addColumn('number', '평균가격');
      data.addColumn('number', '저가');

      data.addRows([
      {% for row in data_len|ranges %}
        [
          new Date("{{ date_time|get_idx:row }}"),
          {{ high_price|get_idx:row }},
          {{ mean_price|get_idx:row }},
          {{ low_price|get_idx:row }},
        ],
      {% endfor %}
      ])


      var options = {
        chart: {
          title: 'Mean price of {{ market_list|get_idx:market|get_idx:'english_name' }}',
          subtitle: '평균가격 (KRW)'
        },
        vAxis: {
          title: 'KRW (log scale)',
          format: 'decimal',
          widths: 100,
          scaleType: 'log', //
          gridlines: {count: 1.5}, //
          titleTextStyle: {italic: false}, //
          viewWindow: {
            min: {{ low_price|get_min }},
            max: {{ high_price|get_max }},
          },
        },
        hAxis: {
          format: 'yy/M/d H:mm',
          gridlines: {count: 3},

        },
        colors: ['#8B0707', '#3366CC', '#E67300'],
        series: {
          0: {
            lineWidth: 1,
            lineDashStyle: [5, 1],
          },
          1: {
            lineWidth: 3,
            lineDashStyle: 1
          },
          2: {
            lineWidth: 1,
            lineDashStyle: [5, 1],
          },
        },
        chartArea: {
          left: '10%',
          width: '75%',
          height: '90%'
        },
      };
      // var chart = new google.charts.Line(document.getElementById('linechart_material'));
      // chart.draw(data, google.charts.Line.convertOptions(options));

      // tooltip 추가 예정
      var chart = new google.visualization.LineChart(document.getElementById('linechart_material'));
      chart.draw(data, options);
    }
    </script>
  </head>
  <head>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['bar']});
      google.charts.setOnLoadCallback(drawStuff);

    function drawStuff() {

      var data = new google.visualization.DataTable();
      data.addColumn('datetime', 'Time');
      data.addColumn('number', '거래금액');

      data.addRows([
      {% for row in data_len|ranges %}
        [
          new Date("{{ date_time|get_idx:row }}"),
          {{ trade_price_account|get_idx:row }},
        ],
      {% endfor %}
      ])


      var options = {
        chart: {
          title: 'Trade price account of {{ market_list|get_idx:market|get_idx:'english_name' }}',
          subtitle: '거래금액 (KRW)'
        },
        vAxis: {
          title: 'KRW (log scale)',
          format: 'short',
          widths: 100,
          scaleType: 'log', //
          gridlines: { count: 1.5 }, //
          titleTextStyle: { italic: false }, //
        },
        hAxis: {
          format: 'yy/M/d H:mm',
          gridlines: { count: 3 },
        },
        chartArea: {
          left: '9.5%',
          width: '76%',
          height: '70%'
        },
        bar: { groupWidth: '100%' },
      };

      // var chart = new google.charts.Bar(document.getElementById('top_x_div'));
      // chart.draw(data, google.charts.Bar.convertOptions(options));

      // tooltip 추가 예정
      var chart = new google.visualization.ColumnChart(document.getElementById('top_x_div'));
      chart.draw(data, options);
    };
    </script>
  </head>
</html>
<div class="container my-3">
    <div class="row justify-content-start my-3">
        <div class="col-3">
            <select class="form-control market">
                {% for ml in market_list|get_keys %}
                <option value="{{ ml }}" {% if market == ml %}selected{% endif %}>
                    {{ market_list|get_idx:ml|get_idx:'korean_name' }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-1.5">
            <select class="form-control unit">
                {% for un in unit_str %}
                <option value="{{ un }}" {% if unit == un %}selected{% endif %}>
                    {{ unit_str|get_idx:un }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="container">
        <div class="row justify-content-between my-3">
            <span>Mean price of {{ market_list|get_idx:market|get_idx:'english_name' }}</span>
            <span>
                마지막 거래시각: {{ date_time_last }} &nbsp;
                <button class="btn btn-outline-secondary btn-sm" onClick="window.location.reload()">새로고침</button>
            </span>
            <div id="linechart_material" style="width: 100%; height: 400px"></div>
        </div>
        <br>
        <div class="row justify-content-between my-3">
            <p>Trade price account of {{ market_list|get_idx:market|get_idx:'english_name' }}</p>
            <div id="top_x_div" style="width: 100%; height: 150px"></div>
        </div>
    </div>
<!--    test-->
<!--    {{ market_list|get_idx:'KRW-BTC'|get_idx:'korean_name' }}-->
<!--    {{ market_list|get_keys }}-->

</div>
<form id="searchForm" method="get" action="{% url 'coinanser:market_data' %}">
    <input type="hidden" id="market" name="market" value="{{ market }}">
    <input type="hidden" id="unit" name="unit" value="{{ unit }}">
</form>
{% endblock %}
{% block script %}
<script type='text/javascript'>
$(document).ready(function(){
    $(".market").on('change', function() {
        $("#market").val($(this).val());
        $("#searchForm").submit();
    });
    $(".unit").on('change', function() {
        $("#unit").val($(this).val());
        $("#searchForm").submit();
    });
});
</script>
{% endblock %}


